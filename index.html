<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EthMetric | Measuring Ethereum</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.3/css/bootstrap.min.css">
    <script type="text/javascript" src="https://registry.npmmirror.com/echarts/5.5.1/files/dist/echarts.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.3/js/bootstrap.bundle.min.js"></script>
    <style>
      .chart {
        background-color: #fbfbfb;
        border: 1px solid #dee2e6;
        display: flex;
        align-items: center;
        justify-content: center;
        aspect-ratio: 4 / 3;
      }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <div class="container">
            <a class="navbar-brand" href="#">EthMetric</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link active" aria-current="page" href="#">Overview</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">Staking</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#">Blobs</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link">Holders</a>
                    </li>
                </ul>
                <div class="ms-auto">
                  <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="showethprice">
                    <label class="form-check-label text-muted" for="showethprice">Show ETH Price</label>
                  </div>
                </div>
            </div>
        </div>
    </nav>
    <div class="container mt-4">
        <div class="row">
          <div class="col-12 col-md-4 mt-1 mb-3">
              <div class="chart" id="container"></div>
          </div>
          <div class="col-12 col-md-4 mt-1 mb-3">
              <div class="chart" id="container2"></div>
          </div>
          <div class="col-12 col-md-4 mt-1 mb-3">
              <div class="chart" id="container3"></div>
          </div>
          <div class="col-12 col-md-4 mt-1 mb-3">
              <div class="chart" id="container4"></div>
          </div>
          <div class="col-12 col-md-4 mt-1 mb-3">
              <div class="chart" id="container5"></div>
          </div>
          <div class="col-12 col-md-4 mt-1 mb-3">
              <div class="chart" id="container6"></div>
          </div>
          <div class="col-12 col-md-4 mt-1 mb-3">
              <div class="chart" id="container7"></div>
          </div>
          <div class="col-12 col-md-4 mt-1 mb-3">
              <div class="chart" id="container8"></div>
          </div>
          <div class="col-12 col-md-4 mt-1 mb-3">
              <div class="chart" id="container9"></div>
          </div>
        </div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.1.3/js/bootstrap.bundle.min.js"></script>
    <script type="text/javascript">
      
    var dom = document.getElementById('container');
    var myChart = echarts.init(dom, null, {
      renderer: 'canvas',
      useDirtyRect: false
    });
    var option = {
      graphic: {
        elements: [
          {
            type: 'text',
            left: 'center',
            top: 'center',
            style: {
              text: 'ethmetric',
              fontSize: 50,
              fontWeight: 'bold',
              fill: 'rgba(0, 0, 0, 0.1)'
            }
          }
        ]
      },
      legend: {
        data: ['Deposit', 'Withdrawl', 'ETH_Price'],
        top: '10%',
        selected: {
          'ETH_Price': false
        }
      },
      tooltip: {
        trigger: 'axis',
        position: function (pt) {
          return [pt[0], '10%'];
        }
      },
      title: {
        left: 'center',
        text: 'Beacon Deposit and Withdrawl',
      },
      toolbox: {
        feature: {
          saveAsImage: {}
        }
      },
      xAxis: {
        type: 'time',
        boundaryGap: false
      },
      yAxis: [{
        type: 'value',
        max: 6e7,
        boundaryGap: [0, '100%'],
        position: 'left',
        axisLabel: {
          formatter: function (value) {
            return value.toExponential();
          }
        }
      },{
        type: 'value',
        max: 5e3,
        boundaryGap: [0, '100%'],
        position: 'right'
      }],
      dataZoom: [
        {
          type: 'inside',
          start: 0,
          end: 100
        },
        {
          start: 0,
          end: 100
        }
      ],
      series: [
        {
          name: 'Deposit',
          type: 'line',
          symbol: 'none',
          areaStyle: {},
          data: [],
          yAxisIndex: 0
        },
        {
          name: 'Withdrawl',
          type: 'line',
          symbol: 'none',
          areaStyle: {},
          data: [],
          yAxisIndex: 0
        },
        {
          name: 'ETH_Price',
          type: 'line',
          symbol: 'none',
          data: [],
          yAxisIndex: 1,
          color: '#bbbbbb'
        }
      ]
    };



    var dom2 = document.getElementById('container2');
    var myChart2 = echarts.init(dom2, null, {
      renderer: 'canvas',
      useDirtyRect: false
    });
    var option2 = {
      graphic: {
        elements: [
          {
            type: 'text',
            left: 'center',
            top: 'center',
            style: {
              text: 'ethmetric',
              fontSize: 50,
              fontWeight: 'bold',
              fill: 'rgba(0, 0, 0, 0.1)'
            }
          }
        ]
      },
      legend: {
        data: ['Deposit-Withdrawl', 'ETH_Price'],
        top: '10%',
        selected: {
          'ETH_Price': false
        }
      },
      tooltip: {
        trigger: 'axis',
        position: function (pt) {
          return [pt[0], '10%'];
        }
      },
      
      title: {
        left: 'center',
        text: 'Beacon Staking',
      },
      toolbox: {
        feature: {
          saveAsImage: {}
        }
      },
      xAxis: {
        type: 'time',
        boundaryGap: false
      },
      yAxis: [{
        min: 0,
        max: 4e7,
        type: 'value',
        boundaryGap: [0, '100%'],
        axisLabel: {
          formatter: function (value) {
            return value.toExponential();
          }
        }
      },{
        type: 'value',
        max: 5e3,
        boundaryGap: [0, '100%'],
        position: 'right'
      }],
      dataZoom: [
        {
          type: 'inside',
          start: 0,
          end: 100
        },
        {
          start: 0,
          end: 100
        }
      ],
      series: [
        {
          name: 'Deposit-Withdrawl',
          type: 'line',
          symbol: 'none',
          areaStyle: {},
          data: [],
        },
        {
          name: 'ETH_Price',
          type: 'line',
          symbol: 'none',
          data: [],
          yAxisIndex: 1,
          color: '#bbbbbb'
        }
      ]
    };



    var dom3 = document.getElementById('container3');
    var myChart3 = echarts.init(dom3, null, {
      renderer: 'canvas',
      useDirtyRect: false
    });
    var option3 = {
      graphic: {
        elements: [
          {
            type: 'text',
            left: 'center',
            top: 'center',
            style: {
              text: 'ethmetric',
              fontSize: 50,
              fontWeight: 'bold',
              fill: 'rgba(0, 0, 0, 0.1)'
            }
          }
        ]
      },
      legend: {
        data: ['Deposit-Withdrawl', 'ETH_Price'],
        top: '10%',
        selected: {
          'ETH_Price': false
        }
      },
      tooltip: {
        trigger: 'axis',
        position: function (pt) {
          return [pt[0], '10%'];
        }
      },
      title: {
        left: 'center',
        text: 'Beacon Staking Changes',
      },
      toolbox: {
        feature: {
          saveAsImage: {}
        }
      },
      xAxis: {
        type: 'time',
        boundaryGap: false
      },
      yAxis: [{
        min: -4e5,
        max: 4e5,
        type: 'value',
        boundaryGap: [0, '100%'],
        axisLabel: {
          formatter: function (value) {
            return value.toExponential();
          }
        },
      },{
        type: 'value',
        max: 5e3,
        boundaryGap: [0, '100%'],
        position: 'right'
      }],
      dataZoom: [
      {
        type: 'inside',
        start: 0,
        end: 100
      },
      {
        start: 0,
        end: 100
      }
      ],
      series: [
        {
          name: 'Deposit-Withdrawl',
          type: 'bar',
          symbol: 'none',
          itemStyle: {
          color: function (params) {
            return params.value[1] >= 0 ? 'green' : 'red';
          }
          },
          data: [],
        },{
          name: 'ETH_Price',
          type: 'line',
          symbol: 'none',
          data: [],
          yAxisIndex: 1,
          color: '#bbbbbb'
        }
      ]
    }




    
    var dom4 = document.getElementById('container4');
    var myChart4 = echarts.init(dom4, null, {
      renderer: 'canvas',
      useDirtyRect: false
    });
    var option4 = {
      graphic: {
        elements: [
          {
            type: 'text',
            left: 'center',
            top: 'center',
            style: {
              text: 'ethmetric',
              fontSize: 50,
              fontWeight: 'bold',
              fill: 'rgba(0, 0, 0, 0.1)'
            }
          }
        ]
      },
      legend: {
        data: ['BlobCountPerBlock', 'ETH_Price'],
        top: '10%',
        selected: {
          'ETH_Price': false
        }
      },
      tooltip: {
        trigger: 'axis',
        position: function (pt) {
          return [pt[0], '10%'];
        }
      },
      
      title: {
        left: 'center',
        text: 'Blob Count Per Block',
      },
      toolbox: {
        feature: {
          saveAsImage: {}
        }
      },
      xAxis: {
        type: 'time',
        boundaryGap: false
      },
      yAxis: [{
        type: 'value',
        boundaryGap: [0, '100%']
      },{
        type: 'value',
        max: 5e3,
        boundaryGap: [0, '100%'],
        position: 'right'
      }],
      dataZoom: [
        {
          type: 'inside',
          start: 0,
          end: 100
        },
        {
          start: 0,
          end: 100
        }
      ],
      series: [
        {
          name: 'BlobCountPerBlock',
          type: 'line',
          symbol: 'none',
          areaStyle: {},
          data: [],
        },
        {
          name: 'ETH_Price',
          type: 'line',
          symbol: 'none',
          data: [],
          yAxisIndex: 1,
          color: '#bbbbbb'
        }
      ]
    };



    
    var dom5 = document.getElementById('container5');
    var myChart5 = echarts.init(dom5, null, {
      renderer: 'canvas',
      useDirtyRect: false
    });
    var option5 = {
      graphic: {
        elements: [
          {
            type: 'text',
            left: 'center',
            top: 'center',
            style: {
              text: 'ethmetric',
              fontSize: 50,
              fontWeight: 'bold',
              fill: 'rgba(0, 0, 0, 0.1)'
            }
          }
        ]
      },
      legend: {
        data: ['BlobFees', 'ETH_Price'],
        top: '10%',
        selected: {
          'ETH_Price': false
        }
      },
      tooltip: {
        trigger: 'axis',
        position: function (pt) {
          return [pt[0], '10%'];
        }
      },
      
      title: {
        left: 'center',
        text: 'Blob Fees',
      },
      toolbox: {
        feature: {
          saveAsImage: {}
        }
      },
      xAxis: {
        type: 'time',
        boundaryGap: false
      },
      yAxis: [{
        type: 'value',
        boundaryGap: [0, '100%'],
      },{
        type: 'value',
        max: 5e3,
        boundaryGap: [0, '100%'],
        position: 'right'
      }],
      dataZoom: [
        {
          type: 'inside',
          start: 0,
          end: 100
        },
        {
          start: 0,
          end: 100
        }
      ],
      series: [
        {
          name: 'BlobFees',
          type: 'line',
          symbol: 'none',
          areaStyle: {},
          data: [],
        },
        {
          name: 'ETH_Price',
          type: 'line',
          symbol: 'none',
          data: [],
          yAxisIndex: 1,
          color: '#bbbbbb'
        }
      ]
    };

    

    function get_beacon_deposit(callback) {
      let xhr = new XMLHttpRequest();
      xhr.open('GET', 'process/chart_data/beacon_deposit.txt', true);
      xhr.onreadystatechange = function () {
        if (xhr.readyState == 4 && xhr.status == 200) {
          lines = xhr.responseText.split('\n');
          for (let i = 0; i < lines.length; i++) {
            let line = lines[i].split(',');
            option.series[0].data.push([line[0], Math.floor(line[1])]);
          }
          callback();
        }
      };
      xhr.send();
    }


    function get_beacon_withdrawl(callback) {
      let xhr = new XMLHttpRequest();
      xhr.open('GET', 'process/chart_data/beacon_withdrawl.txt', true);
      xhr.onreadystatechange = function () {
        if (xhr.readyState == 4 && xhr.status == 200) {
          lines = xhr.responseText.split('\n');
          for (let i = 0; i < lines.length; i++) {
            let line = lines[i].split(',');
            option.series[1].data.push([line[0], Math.floor(line[1])]);
          }
          callback();
        }
      };
      xhr.send();
    }


    var ethprices = [];
    function get_ethprice(callback) {
      let xhr = new XMLHttpRequest();
      xhr.open('GET', 'process/chart_data/ethprice.txt', true);
      xhr.onreadystatechange = function () {
        if (xhr.readyState == 4 && xhr.status == 200) {
          lines = xhr.responseText.split('\n');
          for (let i = 0; i < lines.length; i++) {
            let line = lines[i].split(',');
            ethprices.push([line[0], Math.floor(line[1])]);
          }
          callback();
        }
      };
      xhr.send();
    }

    function get_blob_cnt_per_block(callback) {
      let xhr = new XMLHttpRequest();
      xhr.open('GET', 'process/chart_data/blob_cnt_per_block.txt', true);
      xhr.onreadystatechange = function () {
        if (xhr.readyState == 4 && xhr.status == 200) {
          lines = xhr.responseText.split('\n');
          for (let i = 0; i < lines.length; i++) {
            let line = lines[i].split(',');
            option4.series[0].data.push([line[0], parseFloat(line[1])]);
          }
          callback();
        }
      };
      xhr.send();
    }


    function get_blob_fees(callback) {
      let xhr = new XMLHttpRequest();
      xhr.open('GET', 'process/chart_data/blob_fees.txt', true);
      xhr.onreadystatechange = function () {
        if (xhr.readyState == 4 && xhr.status == 200) {
          lines = xhr.responseText.split('\n');
          for (let i = 0; i < lines.length; i++) {
            let line = lines[i].split(',');
            option5.series[0].data.push([line[0], parseFloat(line[1])]);
          }
          callback();
        }
      };
      xhr.send();
    }


    get_ethprice(function () {
      get_beacon_deposit(function () {
        get_beacon_withdrawl(function () {
          let withdrawls_length = option.series[1].data.length;
          let only_deposit_length = option.series[0].data.length - withdrawls_length;

          for (let i = 0; i < only_deposit_length; i++) {
            option2.series[0].data.push(option.series[0].data[i]);
          }

          for (let i=0; i < withdrawls_length; i++) {
            let j = only_deposit_length + i;
            option2.series[0].data.push([option.series[1].data[i][0], option.series[0].data[j][1] - option.series[1].data[i][1]]);
          }

          for (let i=1; i<option2.series[0].data.length; i++) {
            option3.series[0].data.push([option2.series[0].data[i][0], option2.series[0].data[i][1] - option2.series[0].data[i-1][1]]);
          }

          console.log(ethprices)
          console.log(option.series[0].data)
          for (let i in ethprices) {
            let begin = option.series[0].data[0][0];
            let end = option.series[0].data[option.series[0].data.length - 2][0];
            if (ethprices[i][0] >= begin && ethprices[i][0] <= end) {
                option.series[2].data.push(ethprices[i]);
                option2.series[1].data.push(ethprices[i]);
                option3.series[1].data.push(ethprices[i]);
              }
          }
          myChart.setOption(option);
          myChart2.setOption(option2);
          myChart3.setOption(option3);

        });
      });

      get_blob_cnt_per_block(function (){
        get_blob_fees(function () {
          for (let i in ethprices) {
            let begin = option4.series[0].data[0][0];
            let end = option4.series[0].data[option4.series[0].data.length - 2][0];
            if (ethprices[i][0] >= begin && ethprices[i][0] <= end) {
              option4.series[1].data.push(ethprices[i]);
              option5.series[1].data.push(ethprices[i]);
            }
          }
          myChart4.setOption(option4);
          myChart5.setOption(option5);
        });
      })

    });

    document.getElementById("showethprice").addEventListener("change", function() {
      if (this.checked) {
        option.legend.selected['ETH_Price'] = true;
        option2.legend.selected['ETH_Price'] = true;
        option3.legend.selected['ETH_Price'] = true;
        option4.legend.selected['ETH_Price'] = true;
        option5.legend.selected['ETH_Price'] = true;
      } else {
        option.legend.selected['ETH_Price'] = false;
        option2.legend.selected['ETH_Price'] = false;
        option3.legend.selected['ETH_Price'] = false;
        option4.legend.selected['ETH_Price'] = false;
        option5.legend.selected['ETH_Price'] = false;
      }
      myChart.setOption(option);
      myChart2.setOption(option2);
      myChart3.setOption(option3);
      myChart4.setOption(option4);
      myChart5.setOption(option5);
    });

    window.addEventListener('resize', myChart.resize);
    window.addEventListener('resize', myChart2.resize);
    window.addEventListener('resize', myChart3.resize);
    window.addEventListener('resize', myChart4.resize);
    window.addEventListener('resize', myChart5.resize);
    </script>
</body>
</html>